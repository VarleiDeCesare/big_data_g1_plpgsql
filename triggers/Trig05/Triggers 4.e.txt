CREATE OR REPLACE FUNCTION EXCLUI_PEDIDO()
RETURNS TRIGGER AS
$BODY$
BEGIN
  UPDATE PEDIDO
     SET STATUS = 'I',
         DATA_CANCELAMENTO = NOW()
   WHERE COD_PEDIDO = OLD.COD_PEDIDO;
  RAISE NOTICE 'O pedido foi cancelado e o seu status foi alterado para inativado. Todas as reservas referente a este pedido foram exclu√≠das.';
  RETURN NEW;
END;
$BODY$ LANGUAGE PLPGSQL;

CREATE OR REPLACE FUNCTION EXCLUI_RESERA()
RETURNS TRIGGER AS
$BODY$
BEGIN
  IF (OLD.STATUS = 'A') AND
     (NEW.STATUS = 'I') THEN
    DELETE FROM RESERVA 
     WHERE COD_PEDIDO = OLD.COD_PEDIDO;
    RETURN NEW;
  END IF;
END;
$BODY$ LANGUAGE PLPGSQL;

CREATE TRIGGER CANCELA_PEDIDO
BEFORE DELETE
    ON PEDIDO
   FOR EACH ROW
EXECUTE PROCEDURE EXCLUI_PEDIDO();

CREATE TRIGGER CANCELA_RESERVA
 AFTER UPDATE
    ON PEDIDO
   FOR EACH ROW
EXECUTE PROCEDURE EXCLUI_RESERA();

DELETE FROM PEDIDO WHERE COD_PEDIDO = 6
